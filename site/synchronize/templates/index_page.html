{% extends 'base/base.html' %}
{% load static %}
{% block main %}
<div class="osnova">
  <div class="px-4 py-5 my-5 text-center">
    <h1 class="title display-5 fw-bold">Synchronize</h1>
    <p>–°–µ—Ä–≤–∏—Å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∫–∏ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Ñ–∞–π–ª–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)</p>
  </div>

  <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:</p>

  <form id="local-form">
    {% csrf_token %}
    <div class="mb-3">
      <label for="encryption-key" class="form-label">–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏</label>
      <input type="password" class="form-control" id="encryption-key" name="key" required minlength="8">
      <div style = "font-size: 1.3vh;">
        –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤. –î–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ –∫–ª—é—á, —á—Ç–æ –∏ –ø—Ä–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏.
      </div>
    </div>
    
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
    <div class="mb-3">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="mode" id="mode-encrypt" value="encrypt" checked>
        <label class="form-check-label" for="mode-encrypt">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="mode" id="mode-decrypt" value="decrypt">
        <label class="form-check-label" for="mode-decrypt">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</label>
      </div>
      <div style = "font-size: 1.3vh;">
        –§–∞–π–ª—ã –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ <code>.enc</code>
      </div>
    </div>

    <div class="mb-3">
      <input class="form-control" type="file" id="local-file" name="file" required>
    </div>
    
    <div class="d-flex flex-wrap gap-2 mb-3">
      <button type="submit" class="btn btn-primary">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
      <button type="button" class="btn btn-success" id="download-btn" style="display:none;">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
      <button type="button" class="btn btn-info" id="send-btn" style="display:none;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
    </div>
  </form>

  <div id="status" class="mt-3 alert alert-secondary" role="alert">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
  <pre id="output" class="mt-3 bg-light p-3 rounded" style="white-space:pre-wrap; max-height:300px; overflow:auto;"></pre>
</div>

<style>
  .osnova {
    min-height: calc(100vh - 120px);
    padding-bottom: 80px;
    margin-bottom: 40px;
  }
  
  footer {
    position: static !important;
    margin-top: 20px;
  }
  
  [data-bs-theme="dark"] .form-control,
  [data-bs-theme="dark"] input[type="password"],
  [data-bs-theme="dark"] label,
  [data-bs-theme="dark"] .form-text {
    background-color: #1e1e1e !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
  }
  
  [data-bs-theme="dark"] .alert {
    color: #e0e0e0 !important;
  }
  
  [data-bs-theme="dark"] .alert-secondary {
    background-color: #2d2d2d !important;
  }
  
  [data-bs-theme="dark"] .alert-success {
    background-color: #1a3d1a !important;
  }
  
  [data-bs-theme="dark"] .alert-info {
    background-color: #1a2e3d !important;
  }
  
  [data-bs-theme="dark"] .alert-warning {
    background-color: #3d3d1a !important;
  }
  
  [data-bs-theme="dark"] .alert-danger {
    background-color: #3d1a1a !important;
  }
  
  [data-bs-theme="dark"] pre {
    background-color: #1e1e1e !important;
    color: #e0e0e0 !important;
  }
  
  .btn {
    white-space: nowrap;
    min-width: 120px;
  }
</style>

<script>
  const ENCRYPT_PY_URL = '{% static "scripts/encrypt.py" %}';
</script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<script>
  let pyodide;
  async function initPyodide() {
    if (!pyodide) {
      updateStatus('info', '–ó–∞–≥—Ä—É–∂–∞—é Pyodide...');
      pyodide = await loadPyodide({ 
        indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/'
      });
      await pyodide.loadPackage("micropip");
      const micropip = pyodide.pyimport("micropip");
      await micropip.install("cryptography");
      updateStatus('success', 'Pyodide –≥–æ—Ç–æ–≤');
    }
  }

  function updateStatus(type, message) {
    const el = document.getElementById('status');
    el.textContent = message;
    el.className = `mt-3 alert alert-${type}`;
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
    if (document.documentElement.getAttribute('data-bs-theme') === 'dark') {
      el.style.color = '#e0e0e0';
      if (type === 'secondary') el.style.backgroundColor = '#2d2d2d';
      if (type === 'success') el.style.backgroundColor = '#1a3d1a';
      if (type === 'info') el.style.backgroundColor = '#1a2e3d';
      if (type === 'warning') el.style.backgroundColor = '#3d3d1a';
      if (type === 'danger') el.style.backgroundColor = '#3d1a1a';
    }
  }

  async function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞.'));
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.readAsDataURL(file);
    });
  }

  function b64toBlob(b64Data, contentType = '') {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
      const slice = byteCharacters.slice(offset, offset + 512);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      byteArrays.push(new Uint8Array(byteNumbers));
    }
    return new Blob(byteArrays, { type: contentType });
  }

  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
  document.getElementById('local-form').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const fileInput = document.getElementById('local-file');
    const keyInput = document.getElementById('encryption-key');
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const outputEl = document.getElementById('output');
    const downloadBtn = document.getElementById('download-btn');
    const sendBtn = document.getElementById('send-btn');

    outputEl.textContent = '';
    downloadBtn.style.display = 'none';
    sendBtn.style.display = 'none';

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!fileInput.files[0]) return updateStatus('danger', '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
    if (keyInput.value.length < 8) return updateStatus('danger', '–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤');

    try {
      updateStatus('warning', '–ß–∏—Ç–∞—é —Ñ–∞–π–ª...');
      const file = fileInput.files[0];
      const b64data = await readFileAsDataURL(file);

      await initPyodide();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º Python-—Å–∫—Ä–∏–ø—Ç
      updateStatus('info', '–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥—É–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...');
      const encryptPyCode = await (await fetch(ENCRYPT_PY_URL)).text();
      await pyodide.runPythonAsync(encryptPyCode);

      pyodide.globals.set('b64data', b64data);
      
      updateStatus('info', mode === 'encrypt' ? '–®–∏—Ñ—Ä—É—é...' : '–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é...');
      const resultDict = pyodide
        .runPython(`
process_file(
  b64data,
  ${JSON.stringify(file.name)},
  ${JSON.stringify(file.type)},
  ${JSON.stringify(keyInput.value.trim())},
  ${JSON.stringify(mode)}
)
        `)
        .toJs();

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      window.lastResult = {
        b64: resultDict.get('result_b64'),
        filename: resultDict.get('result_filename'),
        mime: resultDict.get('result_mime'),
        mode: resultDict.get('mode')
      };

      // –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      const size = Math.round((window.lastResult.b64.length * 3) / 4);
      outputEl.textContent = `‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ!\n\n–ò–º—è: ${window.lastResult.filename}\nMIME: ${window.lastResult.mime}\n–†–∞–∑–º–µ—Ä: ${size} –±–∞–π—Ç`;
      
      updateStatus('success', '–ì–æ—Ç–æ–≤–æ! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º');
      downloadBtn.style.display = 'inline-block';
      sendBtn.style.display = 'inline-block';

    } catch (err) {
      console.error(err);
      updateStatus('danger', `–û—à–∏–±–∫–∞: ${err.message || err}`);
    } finally {
      pyodide?.globals.delete('b64data');
    }
  });

  // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  document.getElementById('download-btn').addEventListener('click', () => {
    if (!window.lastResult) return updateStatus('warning', '–°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ —Ñ–∞–π–ª');
    
    try {
      const { b64, filename, mime } = window.lastResult;
      const blob = b64toBlob(b64, mime);
      downloadBlob(blob, filename);
      updateStatus('success', `–§–∞–π–ª "${filename}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ`);
    } catch (err) {
      console.error(err);
      updateStatus('danger', `–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${err.message || err}`);
    }
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  document.getElementById('send-btn').addEventListener('click', async () => {
    if (!window.lastResult) return updateStatus('warning', '–°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ —Ñ–∞–π–ª');

    try {
      const { b64, filename, mime, mode } = window.lastResult;
      let finalFilename = filename;

      // –î–ª—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ {unique}.{ext}.enc
      if (mode === 'encrypt') {
        // –£–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ Python
      }

      const blob = b64toBlob(b64, mime);

      const formData = new FormData();
      formData.append('file', blob, finalFilename);

      updateStatus('info', '–û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
      const response = await fetch('/upload/', {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': getCsrfToken() },
        credentials: 'same-origin'
      });

      if (!response.ok) throw new Error(await response.text());
      
      const resultText = await response.text();
      document.getElementById('output').textContent += `\n\nüì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:\n${resultText}`;
      updateStatus('success', '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
      
    } catch (err) {
      console.error(err);
      updateStatus('danger', `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${err.message || err}`);
    }
  });
</script>
{% endblock %}