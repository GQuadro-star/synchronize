{% extends 'base/base.html' %}
{% load static %}
{% block main %}
<div class="osnova">
  <div class="px-4 py-5 my-5 text-center">
    <h1 class="title display-5 fw-bold">Synchronize</h1>
    <p>сервис для шифровки и расшифровки файлов (локально в браузере)</p>
  </div>

  <p>Выберите файл для локальной обработки (файл сначала обрабатывается локально; затем можно отправить результат на
    сервер):</p>

  <form id="local-form">
    {% csrf_token %}
    <div class="mb-3">
      <label for="encryption-key" class="form-label">Ключ шифрования</label>
      <input type="password" class="form-control" id="encryption-key" name="key" required minlength="8">
      <div class="form-text">Минимум 8 символов.</div>
    </div>
    <div class="mb-3">
      <input class="form-control" type="file" id="local-file" name="file" required>
    </div>
    <button type="submit" class="btn btn-primary" id="process-btn">Обработать локально</button>
    <button type="button" class="btn btn-success" id="send-btn" style="display:none;margin-left:8px;">Отправить
      результат на сервер</button>
  </form>

  <div id="status" class="mt-3"></div>
  <pre id="output" class="mt-3" style="white-space:pre-wrap;"></pre>
</div>

<script>
  const ENCRYPT_PY_URL = '{% static "scripts/encrypt.py" %}';
</script>

<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

<script>
  let pyodide;
  async function initPyodide() {
    if (!pyodide) {
      document.getElementById('status').innerText = 'Загружаю Pyodide...';
      pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/' });
      document.getElementById('status').innerText = 'Pyodide готов.';
    }
  }

  async function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new DOMException('Ошибка чтения файла.'));
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }

  function b64toBlob(b64Data, contentType = '') {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
      const slice = byteCharacters.slice(offset, offset + 512);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      byteArrays.push(new Uint8Array(byteNumbers));
    }
    return new Blob(byteArrays, { type: contentType });
  }

  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  document.getElementById('local-form').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const fileInput = document.getElementById('local-file');
    const keyInput = document.getElementById('encryption-key');
    const statusEl = document.getElementById('status');
    const outputEl = document.getElementById('output');
    const sendBtn = document.getElementById('send-btn');

    outputEl.textContent = '';
    sendBtn.style.display = 'none';

    if (!fileInput.files[0]) {
      statusEl.innerText = 'Файл не выбран.';
      return;
    }
    if (!keyInput.value.trim()) {
      statusEl.innerText = 'Ключ обязателен.';
      return;
    }
    if (keyInput.value.length < 8) {
      statusEl.innerText = 'Ключ должен быть от 8 символов.';
      return;
    }

    try {
      statusEl.innerText = 'Читаю файл...';
      const file = fileInput.files[0];
      const dataUrl = await readFileAsDataURL(file);
      const b64 = dataUrl.split(',')[1];

      await initPyodide();
      await pyodide.loadPackage("micropip");          // сначала загружаем micropip
      const micropip = pyodide.pyimport("micropip");  // импортируем его

      await micropip.install("cryptography");

      statusEl.innerText = 'Загружаю encrypt.py...';
      const encryptPyCode = await (await fetch(ENCRYPT_PY_URL)).text();
      await pyodide.runPythonAsync(encryptPyCode);

      pyodide.globals.set('b64data', b64);

      const resultDict = pyodide
        .runPython(`
process_file(
  b64data,
  ${JSON.stringify(file.name)},
  ${JSON.stringify(file.type)},
  ${JSON.stringify(keyInput.value.trim())}
)
  `)
        .toJs(); // ← БЕЗ dict_converter

      const result_b64 = resultDict.get('result_b64');
      const result_filename = resultDict.get('result_filename');
      const result_mime = resultDict.get('result_mime');




      window.lastResult = { b64: result_b64, filename: result_filename, mime: result_mime };

      outputEl.textContent = `Готово.\nИмя: ${result_filename}\nMIME: ${result_mime}\nРазмер: ${Math.round((result_b64.length * 3) / 4)} байт`;
      statusEl.innerText = 'Обработка завершена.';
      sendBtn.style.display = 'inline-block';

      pyodide.globals.delete('b64data');

    } catch (err) {
      console.error(err);
      statusEl.innerText = 'Ошибка: ' + (err.message || err);
    }
  });

  document.getElementById('send-btn').addEventListener('click', async () => {
    if (!window.lastResult) {
      document.getElementById('status').innerText = 'Сначала обработайте файл.';
      return;
    }

    try {
      const { b64, filename, mime } = window.lastResult;
      const blob = b64toBlob(b64, mime);

      const form = new FormData();
      form.append('file', blob, filename);

      document.getElementById('status').innerText = 'Отправляю...';
      const resp = await fetch('/upload/', {
        method: 'POST',
        body: form,
        headers: { 'X-CSRFToken': getCsrfToken() },
        credentials: 'same-origin'
      });

      const text = await resp.text();
      document.getElementById('output').textContent += '\n\n✅ Отправлено:\n' + text;
      document.getElementById('status').innerText = 'Успешно отправлено.';
    } catch (err) {
      console.error(err);
      document.getElementById('status').innerText = 'Ошибка отправки: ' + (err.message || err);
    }
  });
</script>
{% endblock %}